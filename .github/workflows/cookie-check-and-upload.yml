name: Cookie Check and Avatar Upload

on:
  schedule:
    # 每5分钟运行一次
    - cron: '*/5 * * * *'
  workflow_dispatch:  # 允许手动触发
  push:              # 添加push触发器，方便测试

jobs:
  cookie-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.ACTION_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Run cookie checker
      run: python cookie-keeper.py

  avatar-upload:
    runs-on: ubuntu-latest
    needs: cookie-check  # 确保在cookie检查后运行
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.ACTION_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Run avatar upload and get URL
      run: |
        python upload.py > avatar_output.txt
    
    - name: Update README
      run: |
        # 获取当前时间
        echo "## 最近更新" > temp_readme.md
        echo "更新时间: $(date '+%Y-%m-%d %H:%M:%S')" >> temp_readme.md
        echo "\`\`\`" >> temp_readme.md
        cat avatar_output.txt >> temp_readme.md
        echo "\`\`\`" >> temp_readme.md
        echo "" >> temp_readme.md
        echo "---" >> temp_readme.md
        # 如果README.md存在，追加原有内容
        if [ -f README.md ]; then
          sed '1,/---/d' README.md >> temp_readme.md
        fi
        mv temp_readme.md README.md
    
    - name: Commit and push changes
      env:
        ACTION_TOKEN: ${{ secrets.ACTION_TOKEN }}
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add README.md
        git commit -m "Update avatar URL [skip ci]"
        git remote set-url origin https://x-access-token:${ACTION_TOKEN}@github.com/${{ github.repository }}
        git push